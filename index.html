<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>BolusBuddy Pro</title>
    
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --card: #ffffff; }
        body { font-family: -apple-system, system-ui, sans-serif; margin: 0; background: var(--bg); color: #1e293b; padding-bottom: 50px; }
        .header { background: white; padding: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); text-align: center; position: sticky; top: 0; z-index: 10; }
        .container { padding: 15px; max-width: 500px; margin: 0 auto; }
        .input-group { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 20px; }
        input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        .btn { width: 100%; padding: 14px; border-radius: 8px; border: none; font-weight: 600; font-size: 16px; cursor: pointer; margin-top: 10px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-scan { background: #64748b; color: white; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .food-card { background: var(--card); margin-bottom: 12px; padding: 15px; border-radius: 12px; border: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
        #camera-view { position: fixed; inset: 0; background: black; display: none; z-index: 1000; }
        #video { width: 100%; height: 100%; object-fit: cover; }
        .cam-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80%; height: 30%; border: 2px solid #fff; border-radius: 10px; box-shadow: 0 0 0 9999px rgba(0,0,0,0.5); pointer-events: none; }
        .cam-buttons { position: absolute; bottom: 40px; width: 100%; display: flex; justify-content: space-evenly; align-items: center; }
        .capture-btn { width: 75px; height: 75px; background: white; border-radius: 50%; border: 5px solid rgba(255,255,255,0.3); }
        #scan-loader { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.9); color: white; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 2000; }
    </style>
</head>
<body>
    <div class="header"><h1>BolusBuddy Pro</h1></div>
    <div class="container">
        <div class="input-group">
            <input type="text" id="new-name" placeholder="Food Name">
            <input type="number" id="new-carbs" placeholder="Carbs (g)">
            <input type="number" id="new-fat" placeholder="Fat (g)">
            <button class="btn btn-primary" onclick="saveFood()">Save Entry</button>
            <button class="btn btn-scan" onclick="startScanner()">Scan Label</button>
        </div>
        <div id="food-list"></div>
    </div>
<div id="camera-view">
        <video id="video" autoplay playsinline muted></video>
        <div class="cam-overlay"></div>
        <div class="cam-buttons">
            <button onclick="closeScanner()" style="color:white; background:none; border:none;">Cancel</button>
            <button class="capture-btn" onclick="capture()"></button>
            <div style="width:50px"></div>
        </div>
    </div>

    <div id="scan-loader"><b>Scanning...</b></div>
    <canvas id="canvas" style="display:none;"></canvas>

    <script>
        let foods = JSON.parse(localStorage.getItem('foods') || '[]');
        let camStream = null;

        function renderFoods() {
            const list = document.getElementById('food-list');
            list.innerHTML = foods.map((f, i) => `
                <div class="food-card">
                    <div><b>${f.name}</b><br>C: ${f.carbs}g | F: ${f.fat}g</div>
                    <button onclick="deleteFood(${i})" style="color:red; background:none; border:none;">Delete</button>
                </div>
            `).join('');
        }

        function saveFood() {
            const name = document.getElementById('new-name').value;
            const carbs = document.getElementById('new-carbs').value;
            const fat = document.getElementById('new-fat').value || 0;
            if(!name || !carbs) return alert('Name and Carbs required');
            foods.unshift({ name, carbs, fat });
            localStorage.setItem('foods', JSON.stringify(foods));
            renderFoods();
            document.getElementById('new-name').value = '';
            document.getElementById('new-carbs').value = '';
            document.getElementById('new-fat').value = '';
        }

        function deleteFood(i) {
            foods.splice(i, 1);
            localStorage.setItem('foods', JSON.stringify(foods));
            renderFoods();
        }

async function startScanner() {
            try {
                // We are requesting 1080p and continuous focus
                camStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 },
                        focusMode: 'continuous'
                    } 
                });
                document.getElementById('video').srcObject = camStream;
                document.getElementById('camera-view').style.display = 'block';
            } catch (e) { alert("Camera error: " + e); }
        }

        async function capture() {
            const v = document.getElementById('video');
            const c = document.getElementById('canvas');
            
            // This ensures the photo is taken at the camera's full resolution, not the screen size
            c.width = v.videoWidth; 
            c.height = v.videoHeight; 
            const ctx = c.getContext('2d');
            
            // Draw the full-resolution image
            ctx.drawImage(v, 0, 0);
            
            closeScanner();
            document.getElementById('scan-loader').style.display = "flex";
            
            try {
                // We add 'eng' and a parameter to look for digits specifically
                const res = await Tesseract.recognize(c, 'eng', {
                    logger: m => console.log(m) 
                });
                
                const t = res.data.text.toLowerCase();
                console.log("Detected Text:", t); // You can see this in your phone's debug log

                // Improved matching for "Total Carbs" and "Total Fat"
                const cm = t.match(/(?:carb|carbohydrate|total carb)[\s\w]*?(\d+\.?\d*)/);
                const fm = t.match(/(?:fat|total fat)[\s\w]*?(\d+\.?\d*)/);
                
                if(cm) document.getElementById('new-carbs').value = Math.round(cm[1]);
                if(fm) document.getElementById('new-fat').value = Math.round(fm[1]);
                
                if(!cm && !fm) {
                    alert("Scan complete but no numbers found. Try holding the phone further back (about 10 inches) so the text is sharp.");
                }
            } catch (e) { 
                alert("Scan failed: " + e); 
            }
            document.getElementById('scan-loader').style.display = "none";
        }
	lucide.createIcons();
        renderFoods();
    </script>
</body>
</html>
