<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Carb Tracker â€” Balanced Dualâ€‘Wave</title>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  :root{
    --primary:#1a472a;--accent:#5f9767;--bg:#fafbf9;--surface:#fff;--text:#2a3b2e;--muted:#5a6b5e;--border:#dfe6e0;--danger:#c93a3a;
  }
  body{font-family:-apple-system,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);padding-bottom:160px}
  .header{background:var(--primary);color:#fff;padding:12px 16px;position:sticky;top:0;z-index:100;display:flex;align-items:center;justify-content:space-between}
  .header-left{display:flex;align-items:center;gap:12px}
  h1{font-size:18px;margin-right:6px}
  .preset-select{padding:6px;border-radius:6px;border:none}
  .search-area{background:var(--surface);padding:10px;border-bottom:1px solid var(--border);position:sticky;top:48px;z-index:90}
  .search-box{max-width:980px;margin:0 auto;position:relative}
  .search-input{width:100%;padding:10px 14px 10px 44px;border:1px solid var(--border);border-radius:10px}
  .content{max-width:980px;margin:18px auto;padding:0 12px}
  .category{margin-bottom:20px}
  .category-header{background:#2d6b45;color:#fff;padding:10px;border-radius:8px;display:flex;justify-content:space-between;align-items:center;font-weight:700}
  .items{display:grid;gap:8px;margin-top:10px}
  .item{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:12px;display:grid;grid-template-columns:auto 1fr auto;gap:12px;align-items:center}
  .item.clickable{cursor:pointer}
  .item.selected{border-color:var(--accent);background:#f0f7f2}
  .item-checkbox{width:20px;height:20px;accent-color:var(--accent)}
  .item-name{font-weight:700}
  .item-measure{font-size:13px;color:var(--muted);margin-top:4px}
  .carb-badge{min-width:64px;padding:8px 10px;border-radius:8px;color:#fff;font-weight:800;text-align:center}
  .carb-low{background:#5f9767}
  .carb-moderate{background:#e8a647}
  .carb-high{background:#e87d47}
  .carb-very{background:#d95d47}
  .item-actions{display:flex;gap:8px}
  .btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
  .fab{position:fixed;right:20px;bottom:20px;width:56px;height:56px;border-radius:50%;background:var(--primary);color:#fff;border:none;font-size:24px;z-index:200}
  .meal-total{position:fixed;right:20px;bottom:96px;padding:14px 18px;border-radius:12px;min-width:260px;box-shadow:0 8px 24px rgba(0,0,0,0.2);z-index:150;display:none;border:2px solid rgba(0,0,0,0.06);background:linear-gradient(90deg,#5f9767,#4f8a5b);color:#fff}
  .meal-total.show{display:block}
  .meal-color-low{background:linear-gradient(90deg,#5f9767,#4f8a5b)}
  .meal-color-moderate{background:linear-gradient(90deg,#e8a647,#d79a3f)}
  .meal-color-high{background:linear-gradient(90deg,#e87d47,#d66b3a)}
  .meal-color-very{background:linear-gradient(90deg,#d95d47,#c84b36)}
  .meal-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;font-weight:700}
  #totalCarbs{font-size:20px;font-weight:900;color:#ffffff;text-shadow:0 1px 0 rgba(0,0,0,0.35),0 2px 6px rgba(0,0,0,0.25);letter-spacing:0.4px;font-family:-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif}
  .unit { margin-left:6px; color:#ffffff; font-weight:700; }
  .bolus-info{margin-top:8px;background:rgba(255,255,255,0.06);padding:8px;border-radius:8px;color:#fff}
  .selected-list{margin-top:8px;max-height:160px;overflow:auto;background:rgba(255,255,255,0.06);padding:8px;border-radius:8px}
  .selected-item{display:flex;justify-content:space-between;align-items:center;padding:6px;border-radius:6px}
  .selected-item .remove-btn{background:transparent;border:none;color:#fff;cursor:pointer;padding:6px;border-radius:6px}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:300;padding:12px}
  .modal.active{display:flex}
  .modal-content{background:var(--surface);border-radius:12px;padding:16px;max-width:520px;width:100%;max-height:86vh;overflow:auto}
  .form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .form-input,.form-select{width:100%;padding:10px;border:1px solid var(--border);border-radius:8px}
  .camera-preview{width:100%;max-height:280px;border-radius:8px;object-fit:cover;display:none;margin-top:10px}
  .ocr-status{margin-top:10px;padding:8px;border-radius:8px;font-weight:700;display:none}
  .ocr-status.active{display:block}
  .ocr-success{background:#5f9767;color:#fff}
  .ocr-error{background:#c93a3a;color:#fff}
  .hidden{display:none !important}
  .small-muted{font-size:12px;color:var(--muted)}
  .item-action-btn{background:transparent;border:none;font-size:16px;cursor:pointer;padding:6px;border-radius:6px}
  .clear-meal-btn{background:rgba(255,255,255,0.12);border:none;color:#fff;padding:6px 10px;border-radius:8px;cursor:pointer;margin-left:8px}
  /* ensure fat/protein text in meal panel is white and consistent */
  #bolusBlock, #bolusBlock .small-muted, #bolusBlock span { color: #ffffff !important; }
</style>
</head>
<body>
  <header class="header">
    <div class="header-left">
      <h1>Carb Tracker</h1>
      <div class="small-muted" id="itemCount">0 items</div>
    </div>
    <div>
      <label class="small-muted" for="preset">Dualâ€‘Wave preset</label>
      <select id="preset" class="preset-select" title="Dualâ€‘Wave preset">
        <option value="Balanced">Balanced</option>
        <option value="Conservative">Conservative</option>
        <option value="Aggressive">Aggressive</option>
        <option value="Custom">Custom</option>
      </select>
    </div>
  </header>

  <div class="search-area">
    <div class="search-box">
      <svg style="position:absolute;left:12px;top:50%;transform:translateY(-50%);width:18px;height:18px;color:#7a8a7a" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>
      <input id="searchInput" class="search-input" placeholder="Search foods..." />
    </div>
  </div>

  <main class="content" id="content"></main>

  <button class="fab" id="openAdd" aria-label="Add food">+</button>

  <div id="mealTotal" class="meal-total" role="region" aria-label="Meal total">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <div class="meal-row"><div>Carbs</div><div id="totalCarbs">0 <span class="unit">g</span></div></div>
      <div>
        <button id="clearMeal" class="clear-meal-btn" title="Clear selection">Clear</button>
      </div>
    </div>
    <div id="bolusBlock" class="bolus-info hidden">
      <div id="bolusText" style="font-weight:800"></div>
      <div class="small-muted" style="margin-top:6px">Fat: <span id="totalFat">0</span> g Â· Protein: <span id="totalProtein">0</span> g</div>
      <div class="selected-list" id="selectedList" aria-live="polite"></div>
    </div>
  </div>

  <div class="modal" id="addModal" role="dialog" aria-modal="true">
    <div class="modal-content">
      <h3 id="modalTitle">Add / Edit Food</h3>

      <div style="margin-bottom:10px">
        <button id="scanBtn" class="btn" style="background:var(--accent);color:#fff">ðŸ“¸ Scan Label</button>
        <input id="fileInput" type="file" accept="image/*" capture="environment" class="hidden" />
        <img id="cameraPreview" class="camera-preview" alt="preview" />
        <div id="ocrStatus" class="ocr-status" aria-live="polite"></div>
      </div>

      <div style="margin-top:8px">
        <label class="small-muted">Calculator (from perâ€‘100g label)</label>
        <div class="form-row" style="margin-top:6px">
          <input id="c100" class="form-input" placeholder="Carbs /100g" type="number" step="0.1" />
          <input id="f100" class="form-input" placeholder="Fat /100g" type="number" step="0.1" />
        </div>
        <div style="margin-top:8px" class="form-row">
          <input id="p100" class="form-input" placeholder="Protein /100g" type="number" step="0.1" />
          <input id="serving" class="form-input" placeholder="Serving weight (g)" type="number" />
        </div>
        <div style="margin-top:8px">
          <button id="applyCalc" class="btn" style="background:var(--primary);color:#fff">Apply to Carbs/Fat/Protein</button>
        </div>
      </div>

      <hr style="margin:12px 0;border:none;border-top:1px solid var(--border)" />

      <div style="margin-top:8px">
        <label class="small-muted">Category</label>
        <select id="category" class="form-select"></select>
      </div>

      <div style="margin-top:8px">
        <label class="small-muted">Name</label>
        <input id="name" class="form-input" />
      </div>

      <div style="margin-top:8px">
        <label class="small-muted">Measure</label>
        <input id="measure" class="form-input" />
      </div>

      <div class="form-row" style="margin-top:8px">
        <div>
          <label class="small-muted">Carbs (g)</label>
          <input id="carbs" class="form-input" type="number" step="0.1" />
        </div>
        <div>
          <label class="small-muted">Fat (g)</label>
          <input id="fat" class="form-input" type="number" step="0.1" />
        </div>
      </div>

      <div style="margin-top:8px">
        <label class="small-muted">Protein (g)</label>
        <input id="protein" class="form-input" type="number" step="0.1" />
      </div>

      <div style="margin-top:8px">
        <label class="small-muted">Notes</label>
        <input id="notes" class="form-input" />
      </div>

      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="cancel" class="btn btn-secondary">Cancel</button>
        <button id="save" class="btn" style="background:var(--primary);color:#fff">Save</button>
      </div>
    </div>
  </div>

<script>
/* State and initial data */
const initialData = {
  "Cereal/Breakfasts":[{name:"Muesli",measure:"1/2C",carbs:21,fat:6,protein:4,notes:""}],
  "Dinners":[{name:"Buttermilk Chicken",measure:"1 piece",carbs:34,fat:12,protein:20,notes:""}]
};
let data = {};
let selected = new Set();
let ocrWorker = null;
let workerReady = false;

/* Persistence helpers */
function safeParse(key, fallback){ try{ const v=localStorage.getItem(key); return v?JSON.parse(v):fallback }catch(e){return fallback} }
function saveAll(){ try{ localStorage.setItem('carbData', JSON.stringify(data)); }catch(e){console.error('save error',e);} }
function loadAll(){ const s=safeParse('carbData',null); data = s && typeof s==='object' ? s : initialData; saveAll(); }

/* Preset handling */
const presetEl = document.getElementById('preset');
presetEl.addEventListener('change', () => {
  const v = presetEl.value;
  localStorage.setItem('bb_preset', v);
  if (v === 'Custom') {
    const fatW = parseFloat(prompt('Enter fat weight (e.g., 0.6):', '0.6')) || 0.6;
    const protW = parseFloat(prompt('Enter protein weight (e.g., 0.4):', '0.4')) || 0.4;
    const cap = parseFloat(prompt('Enter percent cap (e.g., 80):', '80')) || 80;
    localStorage.setItem('bb_custom_preset', JSON.stringify({ fatW, protW, cap }));
  }
  render();
});

/* Dual-wave computation (weighted mode kept; Balanced requires >=40% to extend) */
function computeDualWave(carbs, fat, protein, opts = {}) {
  const eps = 1e-4;
  const presetName = opts.preset || localStorage.getItem('bb_preset') || 'Balanced';
  const presets = {
    Conservative: { fatW: 0.5, protW: 0.25, cap: 40 },
    Balanced:     { fatW: 0.6, protW: 0.4,  cap: 80 },
    Aggressive:   { fatW: 0.8, protW: 0.6,  cap: 100 }
  };
  let cfg = presets[presetName] || presets.Balanced;
  if (presetName === 'Custom') {
    const custom = safeParse('bb_custom_preset', {});
    cfg = { fatW: Number(custom.fatW ?? 0.6), protW: Number(custom.protW ?? 0.4), cap: Number(custom.cap ?? 80) };
  }
  cfg.fatW = Number(opts.fatW ?? cfg.fatW);
  cfg.protW = Number(opts.protW ?? cfg.protW);
  cfg.cap = Number(opts.cap ?? cfg.cap);

  const score = (fat * cfg.fatW + protein * cfg.protW) / (carbs + eps);
  let percent = Math.min(Math.max(score * 100, 0), cfg.cap);
  percent = Math.round(percent / 5) * 5;

  // Balanced preset rule: require at least 40% to recommend extended
  if (presetName === 'Balanced' && percent < 40) percent = 0;

  let duration = 0;
  if (percent === 0) duration = 0;
  else if (percent <= 20) duration = 1;
  else if (percent <= 40) duration = 2;
  else if (percent <= 60) duration = 3;
  else duration = 4 + Math.round((percent - 65) / 15 * 2);
  if (duration < 0) duration = 0;

  return { percent, duration, cfg };
}

/* Rendering helpers */
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function escapeJs(s){ return String(s||'').replace(/'/g,"\\'").replace(/"/g,'\\"') }

/* Render list and badges; new items are not auto-selected */
function render(){
  const content = document.getElementById('content');
  const q = (document.getElementById('searchInput').value || '').toLowerCase();
  let total = 0;
  let html = '';
  const cats = Object.keys(data).sort();
  if(cats.length===0){ content.innerHTML = '<div class="small-muted">No foods</div>'; document.getElementById('itemCount').innerText='0 items'; return; }
  cats.forEach(cat=>{
    const items = (data[cat]||[]).filter(it=>{
      return (it.name||'').toLowerCase().includes(q) || (it.measure||'').toLowerCase().includes(q) || (it.notes||'').toLowerCase().includes(q);
    });
    if(items.length===0) return;
    total += items.length;
    html += `<section class="category"><div class="category-header"><div>${escapeHtml(cat)}</div><div class="small-muted">${items.length}</div></div><div class="items">`;
    items.forEach((it, idx)=>{
      const id = `${cat}::${idx}`;
      const isSel = selected.has(id);
      const carbs = Number(it.carbs||0);
      const fat = Number(it.fat||0);
      const protein = Number(it.protein||0);
      const rec = computeDualWave(carbs, fat, protein);
      const later = rec.percent;
      const now = rec.percent === 0 ? 100 : Math.max(0, 100 - later);
      let cls = 'carb-low';
      if(rec.percent >= 50) cls = 'carb-very';
      else if(rec.percent >= 30) cls = 'carb-high';
      else if(rec.percent >= 15) cls = 'carb-moderate';
      html += `<div class="item ${isSel? 'selected':''} item-clickable" data-cat="${escapeHtml(cat)}" data-idx="${idx}">` +
              `<input type="checkbox" class="item-checkbox" ${isSel? 'checked':''} onclick="event.stopPropagation(); toggleSelect('${escapeJs(cat)}',${idx})" aria-label="Select ${escapeHtml(it.name)}" />` +
              `<div><div class="item-name">${escapeHtml(it.name)}</div><div class="item-measure">${escapeHtml(it.measure)}</div></div>` +
              `<div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">` +
              `<div class="carb-badge ${cls}">${carbs}g</div>` +
              `<div class="small-muted" style="font-size:12px">${rec.percent === 0 ? 'Standard' : 'Now '+now+'% Â· Later '+later+'%'}</div>` +
              `<div style="margin-top:6px;display:flex;gap:6px">` +
              `<button class="item-action-btn" title="Edit" onclick="event.stopPropagation(); openEdit('${escapeJs(cat)}',${idx})">âœŽ</button>` +
              `<button class="item-action-btn" title="Delete" onclick="event.stopPropagation(); deleteItem('${escapeJs(cat)}',${idx})">ðŸ—‘</button>` +
              `</div>` +
              `</div></div>`;
    });
    html += `</div></section>`;
  });
  content.innerHTML = html;
  document.getElementById('itemCount').innerText = `${total} items`;
  updateMealPanel();
}

/* Selection toggle and clear */
function toggleSelect(cat, idx){
  const id = `${cat}::${idx}`;
  if(selected.has(id)) selected.delete(id); else selected.add(id);
  render();
}
function clearSelection(){ selected.clear(); render(); }

/* Meal panel: aggregated selection only; Clear button clears selection (not data) */
function updateMealPanel(){
  const mealEl = document.getElementById('mealTotal');
  const bolusBlock = document.getElementById('bolusBlock');
  const selectedList = document.getElementById('selectedList');
  selectedList.innerHTML = '';
  if(selected.size === 0){
    mealEl.className = 'meal-total';
    mealEl.classList.remove('show');
    bolusBlock.classList.add('hidden');
    document.getElementById('totalCarbs').innerHTML='0 <span class="unit">g</span>';
    document.getElementById('totalFat').innerText='0';
    document.getElementById('totalProtein').innerText='0';
    document.getElementById('bolusText').innerText='';
    return;
  }
  let tc=0, tf=0, tp=0;
  const entries = Array.from(selected);
  entries.forEach(id=>{
    const [cat, idx] = id.split('::');
    const it = (data[cat]||[])[Number(idx)];
    if(it){ tc += Number(it.carbs||0); tf += Number(it.fat||0); tp += Number(it.protein||0); }
  });
  document.getElementById('totalCarbs').innerHTML = tc.toFixed(1) + ' <span class="unit">g</span>';
  document.getElementById('totalFat').innerText = tf.toFixed(1);
  document.getElementById('totalProtein').innerText = tp.toFixed(1);
  const rec = computeDualWave(tc, tf, tp);
  const later = rec.percent;
  const now = rec.percent === 0 ? 100 : Math.max(0, 100 - later);
  document.getElementById('bolusText').innerText = rec.percent === 0 ? 'Standard' : `Now ${now}% Â· Later ${later}% Â· ${rec.duration}h`;
  bolusBlock.classList.remove('hidden');
  mealEl.classList.add('show');
  mealEl.classList.remove('meal-color-low','meal-color-moderate','meal-color-high','meal-color-very');
  if(rec.percent >= 50) mealEl.classList.add('meal-color-very');
  else if(rec.percent >= 30) mealEl.classList.add('meal-color-high');
  else if(rec.percent >= 15) mealEl.classList.add('meal-color-moderate');
  else mealEl.classList.add('meal-color-low');

  // build selected list with remove buttons and per-item now/later
  entries.forEach(id=>{
    const [cat, idx] = id.split('::');
    const it = (data[cat]||[])[Number(idx)];
    if(!it) return;
    const carbs = Number(it.carbs||0), fat = Number(it.fat||0), protein = Number(it.protein||0);
    const recItem = computeDualWave(carbs, fat, protein);
    const laterItem = recItem.percent;
    const nowItem = recItem.percent === 0 ? 100 : Math.max(0, 100 - laterItem);
    const div = document.createElement('div');
    div.className = 'selected-item';
    div.innerHTML = `<div style="display:flex;flex-direction:column"><div style="font-weight:700">${escapeHtml(it.name)}</div><div class="small-muted" style="font-size:12px">${carbs}g Â· ${recItem.percent === 0 ? 'Standard' : 'Now '+nowItem+'% Â· Later '+laterItem+'%'}</div></div>` +
                    `<div><button class="remove-btn" title="Remove" onclick="event.stopPropagation(); removeSelected('${escapeJs(id)}')">âœ–</button></div>`;
    selectedList.appendChild(div);
  });
}

/* remove single selected item */
function removeSelected(id){
  selected.delete(id);
  render();
}

/* Clear button wiring */
document.getElementById('clearMeal').addEventListener('click', ()=>{ clearSelection(); });

/* Modal and form wiring */
const openAdd = document.getElementById('openAdd');
const modal = document.getElementById('addModal');
const cancelBtn = document.getElementById('cancel');
const saveBtn = document.getElementById('save');
const categoryEl = document.getElementById('category');
const nameEl = document.getElementById('name');
const measureEl = document.getElementById('measure');
const carbsEl = document.getElementById('carbs');
const fatEl = document.getElementById('fat');
const proteinEl = document.getElementById('protein');
const notesEl = document.getElementById('notes');
const c100El = document.getElementById('c100');
const f100El = document.getElementById('f100');
const p100El = document.getElementById('p100');
const servingEl = document.getElementById('serving');
const applyCalcBtn = document.getElementById('applyCalc');
const fileInput = document.getElementById('fileInput');
const scanBtn = document.getElementById('scanBtn');
const cameraPreview = document.getElementById('cameraPreview');
const ocrStatus = document.getElementById('ocrStatus');

let editContext = null;

openAdd.addEventListener('click', ()=>{ editContext=null; document.getElementById('modalTitle').innerText='Add Food'; populateCategories(); resetForm(); modal.classList.add('active'); });
cancelBtn.addEventListener('click', ()=>{ modal.classList.remove('active'); });

function populateCategories(){
  categoryEl.innerHTML = '';
  Object.keys(data).sort().forEach(k=>{ const o=document.createElement('option'); o.value=k; o.textContent=k; categoryEl.appendChild(o); });
  const o=document.createElement('option'); o.value='__new__'; o.textContent='+ Add new category'; categoryEl.appendChild(o);
}
categoryEl.addEventListener('change', ()=>{ if(categoryEl.value==='__new__'){ const n=prompt('New category name:'); if(n){ data[n]=[]; saveAll(); populateCategories(); categoryEl.value=n; } else categoryEl.value=Object.keys(data)[0]||''; } });

function resetForm(){
  nameEl.value=''; measureEl.value=''; carbsEl.value=''; fatEl.value=''; proteinEl.value=''; notesEl.value=''; c100El.value=''; f100El.value=''; p100El.value=''; servingEl.value=''; applyCalcBtn.disabled=true;
  cameraPreview.src=''; cameraPreview.style.display='none'; ocrStatus.style.display='none'; ocrStatus.innerHTML='';
}

/* Apply calculator */
applyCalcBtn.addEventListener('click', ()=>{
  const c100 = parseFloat(c100El.value) || 0;
  const f100 = parseFloat(f100El.value) || 0;
  const p100 = parseFloat(p100El.value) || 0;
  const w = parseFloat(servingEl.value) || 0;
  if(w>0){
    carbsEl.value = ((c100 * w)/100).toFixed(1);
    fatEl.value = ((f100 * w)/100).toFixed(1);
    proteinEl.value = ((p100 * w)/100).toFixed(1);
  }
});
[c100El,f100El,p100El,servingEl].forEach(el=>el.addEventListener('input', ()=>{ const w=parseFloat(servingEl.value)||0; applyCalcBtn.disabled = !(w>0 && (parseFloat(c100El.value)||0)>0); }));

/* Save item: ensure new item is NOT auto-selected */
saveBtn.addEventListener('click', ()=>{
  const cat = categoryEl.value==='__new__' ? (prompt('Category name:')||'Uncategorized') : categoryEl.value || 'Uncategorized';
  const name = nameEl.value.trim();
  if(!name){ alert('Name required'); return; }
  const item = { name, measure: measureEl.value||'', carbs: parseFloat(carbsEl.value)||0, fat: parseFloat(fatEl.value)||0, protein: parseFloat(proteinEl.value)||0, notes: notesEl.value||'' };
  if(editContext){ const {cat:old, idx} = editContext; data[old][idx] = item; if(old !== cat){ if(!data[cat]) data[cat]=[]; data[cat].push(item); data[old].splice(idx,1); if(data[old].length===0) delete data[old]; } }
  else { if(!data[cat]) data[cat]=[]; data[cat].push(item); }
  saveAll();
  modal.classList.remove('active');
  render();
});

/* Edit helper */
function openEdit(cat, idx){
  editContext = {cat, idx};
  document.getElementById('modalTitle').innerText='Edit Food';
  populateCategories();
  const it = (data[cat]||[])[idx];
  if(it){
    nameEl.value = it.name || '';
    measureEl.value = it.measure || '';
    carbsEl.value = it.carbs || '';
    fatEl.value = it.fat || '';
    proteinEl.value = it.protein || '';
    notesEl.value = it.notes || '';
    categoryEl.value = cat;
  }
  modal.classList.add('active');
}
window.openEdit = openEdit;

/* Delete helper */
function deleteItem(cat, idx){
  if(!confirm('Delete item?')) return;
  const id = `${cat}::${idx}`;
  data[cat].splice(idx,1);
  if(data[cat].length===0) delete data[cat];
  // rebuild selected set to remove invalid ids and adjust indices
  const newSelected = new Set();
  selected.forEach(sid=>{
    const [sc, si] = sid.split('::');
    if(sc === cat){
      const i = Number(si);
      if(i === idx) return; // removed item
      if(i > idx) newSelected.add(`${sc}::${i-1}`); else newSelected.add(sid);
    } else newSelected.add(sid);
  });
  selected = newSelected;
  saveAll();
  render();
}
window.deleteItem = deleteItem;

/* OCR worker and preprocessing with retry button */
async function ensureWorker(){
  if(workerReady) return;
  try{
    if(!ocrWorker) ocrWorker = Tesseract.createWorker({ logger: m => { if(m && typeof m.progress === 'number'){ showOcrStatus('OCR: '+Math.round(m.progress*100)+'%',''); } }});
    await ocrWorker.load(); await ocrWorker.loadLanguage('eng'); await ocrWorker.initialize('eng');
    await ocrWorker.setParameters({ tessedit_char_whitelist:'0123456789.gmper/abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ:-() ', preserve_interword_spaces:'1' });
    workerReady = true;
    showOcrStatus('OCR ready','ocr-success');
  }catch(e){ console.error('worker init',e); workerReady=false; showOcrStatus('OCR engine unavailable','ocr-error'); }
}

function showOcrStatus(text, cls = '') {
  const s = document.getElementById('ocrStatus');
  s.style.display = 'block';
  s.className = 'ocr-status ' + (cls || '');
  s.innerHTML = text;
  if (cls === 'ocr-error') {
    const btn = document.createElement('button');
    btn.textContent = 'Retry OCR';
    btn.className = 'btn';
    btn.style.marginLeft = '8px';
    btn.addEventListener('click', async () => {
      s.innerText = 'Retrying OCR...';
      try { await ensureWorker(); s.innerText = 'OCR ready â€” try scanning again'; } catch(e){ s.innerText = 'Retry failed'; }
    });
    s.appendChild(btn);
  }
}

/* image preprocessing: grayscale + contrast stretch */
function preprocessImage(dataUrl, maxWidth=1200){
  return new Promise((res,rej)=>{
    const img = new Image();
    img.onload = ()=>{
      const scale = Math.min(1, maxWidth / img.width);
      const w = Math.round(img.width * scale);
      const h = Math.round(img.height * scale);
      const c = document.createElement('canvas'); c.width=w; c.height=h;
      const ctx = c.getContext('2d'); ctx.drawImage(img,0,0,w,h);
      const id = ctx.getImageData(0,0,w,h); const d = id.data;
      let min=255,max=0;
      for(let i=0;i<d.length;i+=4){ const lum = 0.299*d[i]+0.587*d[i+1]+0.114*d[i+2]; if(lum<min) min=lum; if(lum>max) max=lum; }
      const range = Math.max(1, max-min);
      for(let i=0;i<d.length;i+=4){ const lum = 0.299*d[i]+0.587*d[i+1]+0.114*d[i+2]; const v = Math.min(255, Math.max(0, (lum-min)*255/range)); d[i]=d[i+1]=d[i+2]=v; }
      ctx.putImageData(id,0,0); res(c.toDataURL('image/png'));
    };
    img.onerror = (e)=> rej(e);
    img.src = dataUrl;
  });
}

async function runOcr(dataUrl){
  try{
    showOcrStatus('Preparing image...','');
    await ensureWorker();
    if(!workerReady){ showOcrStatus('OCR engine unavailable','ocr-error'); return; }
    const pre = await preprocessImage(dataUrl, 1200);
    showOcrStatus('Scanning...','');
    const { data: { text } } = await ocrWorker.recognize(pre);
    showOcrStatus('OCR complete â€” parsing','ocr-success');
    parseLabelText(text || '');
  }catch(e){ console.error('ocr',e); showOcrStatus('OCR failed â€” try a clearer photo','ocr-error'); }
}

/* parse label text for per-100g carbs/fat/protein and serving with fallbacks */
function parseLabelText(text){
  const lower = (text||'').replace(/\r/g,'\n');
  let c100=null,f100=null,p100=null,serv=null;
  const carb100 = /(?:carb|carbohydrate|carbs)[^\d\n\r]{0,40}?(\d+\.?\d*)\s*g\s*(?:\/\s*100g|per\s*100g)?/i;
  const carb100Alt = /(\d+\.?\d*)\s*g\s*(?:\/\s*100g|per\s*100g)[^\n\r]{0,40}?(?:carb|carbohydrate|carbs)/i;
  const fat100 = /(?:fat|total fat)[^\d\n\r]{0,40}?(\d+\.?\d*)\s*g\s*(?:\/\s*100g|per\s*100g)?/i;
  const fat100Alt = /(\d+\.?\d*)\s*g\s*(?:\/\s*100g|per\s*100g)[^\n\r]{0,40}?(?:fat|total fat)/i;
  const prot100 = /(?:protein)[^\d\n\r]{0,40}?(\d+\.?\d*)\s*g\s*(?:\/\s*100g|per\s*100g)?/i;
  const prot100Alt = /(\d+\.?\d*)\s*g\s*(?:\/\s*100g|per\s*100g)[^\n\r]{0,40}?(?:protein)/i;
  const mC = lower.match(carb100) || lower.match(carb100Alt); if(mC) c100 = mC[1];
  const mF = lower.match(fat100) || lower.match(fat100Alt); if(mF) f100 = mF[1];
  const mP = lower.match(prot100) || lower.match(prot100Alt); if(mP) p100 = mP[1];
  const servRegex = /serv(?:ing)?(?: size)?[:\s]*?(\d+\.?\d*)\s*g/i;
  const servParen = /\((\d+\.?\d*)\s*g\)/i;
  const servSimple = /(\d+\.?\d*)\s*g\s*(?:serving|serv)/i;
  const mS = lower.match(servRegex) || lower.match(servParen) || lower.match(servSimple); if(mS) serv = mS[1];

  // fallback: find numbers with 'g' anywhere and assign first three to carbs/fat/protein if labeled not found
  if((!c100 || !f100 || !p100) && lower.match(/\d+\.?\d*\s*g/gi)){
    const allG = Array.from(lower.matchAll(/(\d+\.?\d*)\s*g/gi)).map(m=>m[1]);
    if(allG.length>0 && !c100) c100 = allG[0];
    if(allG.length>1 && !f100) f100 = allG[1];
    if(allG.length>2 && !p100) p100 = allG[2];
  }

  // fallback: numbers without g - take first three numbers
  if((!c100 || !f100 || !p100) && lower.match(/(\d+\.?\d*)/g)){
    const nums = Array.from(lower.matchAll(/(\d+\.?\d*)/g)).map(m=>m[1]);
    if(nums.length>0 && !c100) c100 = nums[0];
    if(nums.length>1 && !f100) f100 = nums[1];
    if(nums.length>2 && !p100) p100 = nums[2];
  }

  // if per-serving values exist and serving weight present, compute per-100
  if(serv && (!c100 || !f100 || !p100)){
    const carbServ = /(?:carb|carbohydrate|carbs)[^\d\n\r]{0,40}?(\d+\.?\d*)\s*g(?!\s*\/\s*100g)/i;
    const fatServ = /(?:fat|total fat)[^\d\n\r]{0,40}?(\d+\.?\d*)\s*g(?!\s*\/\s*100g)/i;
    const protServ = /(?:protein)[^\d\n\r]{0,40}?(\d+\.?\d*)\s*g(?!\s*\/\s*100g)/i;
    const cm = lower.match(carbServ); const fm = lower.match(fatServ); const pm = lower.match(protServ);
    const sv = parseFloat(serv);
    if(cm && !c100 && sv>0) c100 = ((parseFloat(cm[1]) / sv) * 100).toFixed(1);
    if(fm && !f100 && sv>0) f100 = ((parseFloat(fm[1]) / sv) * 100).toFixed(1);
    if(pm && !p100 && sv>0) p100 = ((parseFloat(pm[1]) / sv) * 100).toFixed(1);
  }

  // populate fields
  if(c100) c100El.value = parseFloat(c100).toFixed(1);
  if(f100) f100El.value = parseFloat(f100).toFixed(1);
  if(p100) p100El.value = parseFloat(p100).toFixed(1);
  if(serv) servingEl.value = parseFloat(serv).toFixed(0);

  // enable apply if we have serving and carbs per100
  applyCalcBtn.disabled = !(parseFloat(servingEl.value) > 0 && parseFloat(c100El.value) > 0);

  // final status
  if(c100 || f100 || p100) {
    showOcrStatus('OCR parsed values (populated where found)','ocr-success');
  } else {
    showOcrStatus('No clear nutrition values found. Try a different photo or use calculator','ocr-error');
  }
}

/* file input handling */
fileInput.addEventListener('change', async (ev)=>{
  const f = ev.target.files && ev.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = async ()=> {
    cameraPreview.src = reader.result; cameraPreview.style.display='block';
    showOcrStatus('Processing image...','');
    await runOcr(reader.result);
  };
  reader.readAsDataURL(f);
});
scanBtn.addEventListener('click', ()=> fileInput.click());

/* Initialization */
async function init(){
  loadAll();
  const preset = localStorage.getItem('bb_preset') || 'Balanced';
  presetEl.value = preset;
  render();
  populateCategories();
  document.getElementById('searchInput').addEventListener('input', ()=> render());
  // warm up OCR worker in background to reduce "unavailable" messages
  ensureWorker().catch(()=>{/* handled in ensureWorker */});
  window.addEventListener('beforeunload', async ()=>{ try{ if(ocrWorker && workerReady) await ocrWorker.terminate(); }catch(e){} });
}
init();
</script>
</body>
</html>
